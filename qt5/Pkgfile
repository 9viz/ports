# Description: Qt Free Edition, version 5.x.
# URL: http://www.qt.io/
# Depends on: gdk-pixbuf gst-plugins-base libepoxy libmng libxkbcommon xorg-libxcomposite xorg-libxcursor xorg-libxi xorg-libxinerama xorg-xcb-util-image xorg-xcb-util-keysyms xorg-xcb-util-wm

name=qt5
version=5.13.0
release=1
source=(https://download.qt.io/official_releases/qt/${version%.*}/$version/single/qt-everywhere-src-$version.tar.xz)

build() {
    cd qt-everywhere-src-$version

    # Respect system CXX
    [ "$CXX" ] || CXX=g++
    sed -e "/^QMAKE_CXX\s/s|=.*|= $CXX|" \
        -i qtbase/mkspecs/common/g++-base.conf

    # Remove obsolete xorg path
    sed -e 's|X11R6/||g' -i qtbase/mkspecs/*/*.conf

    # Respect system CXXFLAGS
    sed -e "s|^\(QMAKE_CFLAGS_RELEASE.*\)|\1 ${CXXFLAGS}|" \
        -i qtbase/mkspecs/common/gcc-base.conf

    # Respect system LDFLAGS
    sed -e "s|^\(QMAKE_LFLAGS_RELEASE.*\)|\1 ${LDFLAGS}|" \
        -i qtbase/mkspecs/common/g++-unix.conf

    export QTDIR="$PWD"
    export LD_LIBRARY_PATH="$QTDIR/qtbase/lib:$QTDIR/qttools/lib:$LD_LIBRARY_PATH"
    export QT_PLUGIN_PATH="$QTDIR/qtbase/plugins"

    ./configure \
        -prefix /usr/ \
        -archdatadir /usr/lib/qt5 \
        -bindir /usr/lib/qt5/bin \
        -plugindir /usr/lib/qt5/plugins \
        -importdir /usr/lib/qt5/imports \
        -datadir /usr/share/qt5 \
        -docdir /usr/share/doc/qt5 \
        -translationdir /usr/share/qt5/translations \
        -examplesdir /usr/share/doc/qt5/examples \
        -headerdir /usr/include/qt5 \
        -libdir /usr/lib \
        -sysconfdir /usr/etc/xdg \
        -confirm-license \
        -no-egl \
        -nomake examples \
        -no-pch \
        -no-rpath \
        -no-separate-debug-info \
	-strip \
        -opengl desktop \
        -opensource \
        -openssl-linked \
        -optimized-qmake \
        -xkbcommon \
        -reduce-relocations \
        -release \
        -shared \
        -plugin-sql-sqlite \
        -system-sqlite \
        -system-harfbuzz \
        -skip qtwebengine \
	-no-gtk \
	-no-dbus \
        -silent

    make
    make INSTALL_ROOT=$PKG install

    # Fix paths
    find $PKG/usr/lib/ -type f -name '*.prl' \
        -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d;s/\(QMAKE_PRL_LIBS =\).*/\1/' {} \;

    sed -e "s|$PWD/qtbase|/usr/lib/qt5|g" \
        -i $PKG/usr/lib/qt5/mkspecs/modules/qt_lib_bootstrap_private.pri

    rm -r $PKG/usr/share
}